<!DOCTYPE html><html lang="zh-CN" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="浅析 LeakCanary" /><meta name="author" content="Cyrus" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="发现泄漏对象" /><meta property="og:description" content="发现泄漏对象" /><link rel="canonical" href="https://cyruslin.com/blog/blog/posts/leakcanary/" /><meta property="og:url" content="https://cyruslin.com/blog/blog/posts/leakcanary/" /><meta property="og:site_name" content="Cyrus" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-12T12:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="浅析 LeakCanary" /><meta name="twitter:site" content="@magicboy_linw" /><meta name="twitter:creator" content="@Cyrus" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"浅析 LeakCanary","dateModified":"2021-04-12T12:00:00+08:00","datePublished":"2021-04-12T12:00:00+08:00","description":"发现泄漏对象","url":"https://cyruslin.com/blog/blog/posts/leakcanary/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cyruslin.com/blog/blog/posts/leakcanary/"},"author":{"@type":"Person","name":"Cyrus"},"@context":"https://schema.org"}</script><title>浅析 LeakCanary | Cyrus</title><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/blog/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/blog/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/blog/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/blog/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/blog/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/blog/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/blog/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/blog/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/blog/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/blog/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/blog/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/blog/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/blog/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script defer src="/blog/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="main-wrapper" style="margin-left: 0px;"><div id="main"><div class="row" style="padding-left: 0px;"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8" style="max-width: 75%;margin-top: 0rem;padding-left: 0.5rem;"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>浅析 LeakCanary</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 12, 2021, 12:00 PM +0800" > Apr 12 <i class="unloaded">2021-04-12T12:00:00+08:00</i> </span> by <span class="author"> Cyrus </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1915 words">10 min</span></div></div><div class="post-content"><h2 id="发现泄漏对象">发现泄漏对象</h2><h3 id="四种引用类型">四种引用类型</h3><div class="table-wrapper"><table><tbody><tr><td>强引用<td>平时写代码最常用的引用类型，对象只要被强引用就不会被 GC<tr><td>软引用 <code class="language-plaintext highlighter-rouge">SoftReference</code><td>只有当内存不足时才会被 GC<tr><td>弱引用 <code class="language-plaintext highlighter-rouge">WeakReference</code><td>会被正常 GC<tr><td>虚引用 <code class="language-plaintext highlighter-rouge">PhantomReference</code><td>会被正常 GC，因为 <code class="language-plaintext highlighter-rouge">get()</code> 总是返回 null，一般用来跟踪对象的生命周期</table></div><p>所有的引用类型都可以在构造时与一个 <code class="language-plaintext highlighter-rouge">ReferenceQueue</code> 关联，当引用的对象被 GC 后，这个 <code class="language-plaintext highlighter-rouge">Reference</code> 将被入队到关联的引用队列里</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Reference</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/* -- Constructors -- */</span>

    <span class="nc">Reference</span><span class="o">(</span><span class="no">T</span> <span class="n">referent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">referent</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">Reference</span><span class="o">(</span><span class="no">T</span> <span class="n">referent</span><span class="o">,</span> <span class="nc">ReferenceQueue</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">referent</span> <span class="o">=</span> <span class="n">referent</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="检测-activity-泄漏">检测 <code class="language-plaintext highlighter-rouge">Activity</code> 泄漏</h3><p>通过 <code class="language-plaintext highlighter-rouge">ActivityLifecycleCallbacks.onActivityDestroyed</code> 可以收集到 destoryed <code class="language-plaintext highlighter-rouge">Activity</code>，这些 <code class="language-plaintext highlighter-rouge">Activity</code> 已走完它的生命周期，应该被后续的 GC 回收掉</p><p>用 <code class="language-plaintext highlighter-rouge">WeakReference</code> + <code class="language-plaintext highlighter-rouge">ReferenceQueue</code> 监控它，并用 <code class="language-plaintext highlighter-rouge">watchedObjects = mutableMapOf&lt;String, KeyedWeakReference&gt;()</code> 把它记录起来，key 是 UUID，value 是对这个 <code class="language-plaintext highlighter-rouge">Activity</code> 的弱引用；等待 5s，让 GC 线程有足够的机会去发现并回收这个 <code class="language-plaintext highlighter-rouge">Activity</code> 对象，如果 5s 后 <code class="language-plaintext highlighter-rouge">Activity</code> 仍然没有被 GC（没有出现在引用队列里），那么可以证明这个对象发生了内存泄漏，被强引用导致存活超过它的生命周期</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="c1">// 收集 destroyed Activity</span>
<span class="kd">class</span> <span class="nc">ActivityWatcher</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">application</span><span class="p">:</span> <span class="nc">Application</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">reachabilityWatcher</span><span class="p">:</span> <span class="nc">ReachabilityWatcher</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">InstallableWatcher</span> <span class="p">{</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="py">lifecycleCallbacks</span> <span class="p">=</span>
    <span class="kd">object</span> <span class="err">: </span><span class="nc">Application</span><span class="p">.</span><span class="nc">ActivityLifecycleCallbacks</span> <span class="k">by</span> <span class="nf">noOpDelegate</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onActivityDestroyed</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reachabilityWatcher</span><span class="p">.</span><span class="nf">expectWeaklyReachable</span><span class="p">(</span>
          <span class="n">activity</span><span class="p">,</span> <span class="s">"${activity::class.java.name} received Activity#onDestroy() callback"</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 弱引用这个 Activity 并设置在 5s 后检查此对象有没被 GC</span>
<span class="nd">@Synchronized</span> <span class="k">override</span> <span class="k">fun</span> <span class="nf">expectWeaklyReachable</span><span class="p">(</span>
  <span class="n">watchedObject</span><span class="p">:</span> <span class="nc">Any</span><span class="p">,</span>
  <span class="n">description</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(!</span><span class="nf">isEnabled</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="nf">removeWeaklyReachableObjects</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">key</span> <span class="p">=</span> <span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">watchUptimeMillis</span> <span class="p">=</span> <span class="n">clock</span><span class="p">.</span><span class="nf">uptimeMillis</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">reference</span> <span class="p">=</span>
    <span class="nc">KeyedWeakReference</span><span class="p">(</span><span class="n">watchedObject</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">watchUptimeMillis</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>
  <span class="nc">SharkLog</span><span class="p">.</span><span class="nf">d</span> <span class="p">{</span>
    <span class="s">"Watching "</span> <span class="p">+</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">watchedObject</span> <span class="k">is</span> <span class="nc">Class</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;)</span> <span class="n">watchedObject</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span> <span class="k">else</span> <span class="s">"instance of ${watchedObject.javaClass.name}"</span><span class="p">)</span> <span class="p">+</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">description</span><span class="p">.</span><span class="nf">isNotEmpty</span><span class="p">())</span> <span class="s">" ($description)"</span> <span class="k">else</span> <span class="s">""</span><span class="p">)</span> <span class="p">+</span>
      <span class="s">" with key $key"</span>
  <span class="p">}</span>
  <span class="n">watchedObjects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">reference</span>
  <span class="n">checkRetainedExecutor</span><span class="p">.</span><span class="nf">execute</span> <span class="p">{</span>
    <span class="nf">moveToRetained</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 如果没有出现在引用队列里，说明此对象已发生泄漏，发出通知</span>
<span class="nd">@Synchronized</span> <span class="k">private</span> <span class="k">fun</span> <span class="nf">moveToRetained</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">removeWeaklyReachableObjects</span><span class="p">()</span>    <span class="c1">// 出现在引用队列里说明对象已被 GC，可以从 watchedObjects 移除</span>
  <span class="kd">val</span> <span class="py">retainedRef</span> <span class="p">=</span> <span class="n">watchedObjects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">retainedRef</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retainedRef</span><span class="p">.</span><span class="n">retainedUptimeMillis</span> <span class="p">=</span> <span class="n">clock</span><span class="p">.</span><span class="nf">uptimeMillis</span><span class="p">()</span>
    <span class="n">onObjectRetainedListeners</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">onObjectRetained</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>拓展一下，上面检测 <code class="language-plaintext highlighter-rouge">Activity</code> 泄漏的机制：监控 - 等待 - 检查，其实可以应用到任何对象，包括 <code class="language-plaintext highlighter-rouge">Fragment</code>、<code class="language-plaintext highlighter-rouge">View</code> 等，于是抽象出一个通用的对象泄漏检测工具：<code class="language-plaintext highlighter-rouge">ObjectWatcher</code>，上面的 <code class="language-plaintext highlighter-rouge">expectWeaklyReachable</code> 和 <code class="language-plaintext highlighter-rouge">moveToRetained</code> 都是在 <code class="language-plaintext highlighter-rouge">ObjectWatcher</code> 里实现的</p><h3 id="检测-fragment-和-view-的泄漏">检测 <code class="language-plaintext highlighter-rouge">Fragment</code> 和 <code class="language-plaintext highlighter-rouge">View</code> 的泄漏</h3><p>利用 <code class="language-plaintext highlighter-rouge">FragmentLifecycleCallbacks</code> 发现被 destroyed <code class="language-plaintext highlighter-rouge">Fragment</code> 和 <code class="language-plaintext highlighter-rouge">View</code>，然后用 <code class="language-plaintext highlighter-rouge">ObjectWatcher</code> 监控是否发生泄漏</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="k">internal</span> <span class="kd">class</span> <span class="nc">AndroidXFragmentDestroyWatcher</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">reachabilityWatcher</span><span class="p">:</span> <span class="nc">ReachabilityWatcher</span>
<span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="nc">Activity</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Unit</span> <span class="p">{</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="py">fragmentLifecycleCallbacks</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">FragmentManager</span><span class="p">.</span><span class="nc">FragmentLifecycleCallbacks</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// 发现 View</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFragmentViewDestroyed</span><span class="p">(</span>
      <span class="n">fm</span><span class="p">:</span> <span class="nc">FragmentManager</span><span class="p">,</span>
      <span class="n">fragment</span><span class="p">:</span> <span class="nc">Fragment</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">view</span> <span class="p">=</span> <span class="n">fragment</span><span class="p">.</span><span class="n">view</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">view</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">reachabilityWatcher</span><span class="p">.</span><span class="nf">expectWeaklyReachable</span><span class="p">(</span>
          <span class="n">view</span><span class="p">,</span> <span class="s">"${fragment::class.java.name} received Fragment#onDestroyView() callback "</span> <span class="p">+</span>
          <span class="s">"(references to its views should be cleared to prevent leaks)"</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 发现 Fragment</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFragmentDestroyed</span><span class="p">(</span>
      <span class="n">fm</span><span class="p">:</span> <span class="nc">FragmentManager</span><span class="p">,</span>
      <span class="n">fragment</span><span class="p">:</span> <span class="nc">Fragment</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="n">reachabilityWatcher</span><span class="p">.</span><span class="nf">expectWeaklyReachable</span><span class="p">(</span>
        <span class="n">fragment</span><span class="p">,</span> <span class="s">"${fragment::class.java.name} received Fragment#onDestroy() callback"</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="检测-viewmodel-泄漏">检测 <code class="language-plaintext highlighter-rouge">ViewModel</code> 泄漏</h3><p><code class="language-plaintext highlighter-rouge">Fragment</code> 里的 <code class="language-plaintext highlighter-rouge">ViewModel</code> 则是在 <code class="language-plaintext highlighter-rouge">FragmentLifecycleCallbacks.onFragmentCreated</code> 时，注入一个 <code class="language-plaintext highlighter-rouge">ViewModel</code>，通过反射拿到 <code class="language-plaintext highlighter-rouge">ViewModelStore.mMap</code>，这里有所有的 <code class="language-plaintext highlighter-rouge">ViewModel</code>，在 <code class="language-plaintext highlighter-rouge">ViewModel.onCleared</code> 时把它们加入 <code class="language-plaintext highlighter-rouge">ObjectWatcher</code> 进行泄漏检查</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="k">internal</span> <span class="kd">class</span> <span class="nc">ViewModelClearedWatcher</span><span class="p">(</span>
  <span class="n">storeOwner</span><span class="p">:</span> <span class="nc">ViewModelStoreOwner</span><span class="p">,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">reachabilityWatcher</span><span class="p">:</span> <span class="nc">ReachabilityWatcher</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="py">viewModelMap</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">ViewModel</span><span class="p">&gt;?</span>

  <span class="nf">init</span> <span class="p">{</span>
    <span class="c1">// We could call ViewModelStore#keys with a package spy in androidx.lifecycle instead,</span>
    <span class="c1">// however that was added in 2.1.0 and we support AndroidX first stable release. viewmodel-2.0.0</span>
    <span class="c1">// does not have ViewModelStore#keys. All versions currently have the mMap field.</span>
    <span class="n">viewModelMap</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">mMapField</span> <span class="p">=</span> <span class="nc">ViewModelStore</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="nf">getDeclaredField</span><span class="p">(</span><span class="s">"mMap"</span><span class="p">)</span>
      <span class="n">mMapField</span><span class="p">.</span><span class="n">isAccessible</span> <span class="p">=</span> <span class="k">true</span>
      <span class="nd">@Suppress</span><span class="p">(</span><span class="s">"UNCHECKED_CAST"</span><span class="p">)</span>
      <span class="n">mMapField</span><span class="p">[</span><span class="n">storeOwner</span><span class="p">.</span><span class="n">viewModelStore</span><span class="p">]</span> <span class="k">as</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">ViewModel</span><span class="p">&gt;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ignored</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">null</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCleared</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">viewModelMap</span><span class="o">?.</span><span class="n">values</span><span class="o">?.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">viewModel</span> <span class="p">-&gt;</span>
      <span class="n">reachabilityWatcher</span><span class="p">.</span><span class="nf">expectWeaklyReachable</span><span class="p">(</span>
        <span class="n">viewModel</span><span class="p">,</span> <span class="s">"${viewModel::class.java.name} received ViewModel#onCleared() callback"</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">install</span><span class="p">(</span>
      <span class="n">storeOwner</span><span class="p">:</span> <span class="nc">ViewModelStoreOwner</span><span class="p">,</span>
      <span class="n">reachabilityWatcher</span><span class="p">:</span> <span class="nc">ReachabilityWatcher</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="nc">ViewModelProvider</span><span class="p">(</span><span class="n">storeOwner</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">Factory</span> <span class="p">{</span>
        <span class="nd">@Suppress</span><span class="p">(</span><span class="s">"UNCHECKED_CAST"</span><span class="p">)</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="err">?</span><span class="p">&gt;</span> <span class="nf">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="nc">Class</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">T</span> <span class="p">=</span>
          <span class="nc">ViewModelClearedWatcher</span><span class="p">(</span><span class="n">storeOwner</span><span class="p">,</span> <span class="n">reachabilityWatcher</span><span class="p">)</span> <span class="k">as</span> <span class="nc">T</span>
      <span class="p">})</span>
      <span class="n">provider</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">ViewModelClearedWatcher</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="检测更多类型的泄漏">检测更多类型的泄漏</h3><p>对 <code class="language-plaintext highlighter-rouge">Service</code> 的检查就比较 hack 了，通过反射替换 <code class="language-plaintext highlighter-rouge">ActivityThread.mH.mCallback</code>，通过 <code class="language-plaintext highlighter-rouge">Message.waht == H.STOP_SERVICE</code> 定位到 <code class="language-plaintext highlighter-rouge">ActivityThread.handleStopService</code> 的调用时机，然后把这个被 stop 的 <code class="language-plaintext highlighter-rouge">Service</code> 记录下来；用动态代理实现 <code class="language-plaintext highlighter-rouge">IActivityManager</code> 并替换掉 <code class="language-plaintext highlighter-rouge">ActivityManager.IActivityManagerSinglteon.mInstance</code>，从而拦截方法 <code class="language-plaintext highlighter-rouge">serviceDoneExecuting</code>，此方法的调用表示 <code class="language-plaintext highlighter-rouge">Service</code> 生命周期已完结，可以把它交由 <code class="language-plaintext highlighter-rouge">ObjectWatcher</code> 进行监控</p><p>这给我启示，对于我们感兴趣的对象（需要警惕泄漏的对象，比如 <code class="language-plaintext highlighter-rouge">Bitmap</code>），都可以通过 <code class="language-plaintext highlighter-rouge">ObjectWatcher</code> 去检测泄漏问题</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MyService</span> <span class="p">:</span> <span class="nc">Service</span> <span class="p">{</span>

  <span class="c1">// ...</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="nf">onDestroy</span><span class="p">()</span>
    <span class="nc">AppWatcher</span><span class="p">.</span><span class="n">objectWatcher</span><span class="p">.</span><span class="nf">watch</span><span class="p">(</span>
      <span class="n">watchedObject</span> <span class="p">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="n">description</span> <span class="p">=</span> <span class="s">"MyService received Service#onDestroy() callback"</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="堆转储">堆转储</h2><p>利用 api <code class="language-plaintext highlighter-rouge">Debug#dumpHprofData(fileName)</code>（但是生成的 hprof 文件很大）</p><h2 id="解析堆转储文件">解析堆转储文件</h2><p>利用 <a href="https://square.github.io/leakcanary/shark/">Shark</a>（性能是个问题）</p><h2 id="组织并输出泄漏问题">组织并输出泄漏问题</h2><p>通过 <a href="https://square.github.io/leakcanary/shark/">Shark</a> 找到泄漏对象到 GC Root 的路径</p><h2 id="思考">思考</h2><h3 id="为什么不需要手动初始化">为什么不需要手动初始化？</h3><p><code class="language-plaintext highlighter-rouge">LeakCanary</code> 把初始化代码放在 <code class="language-plaintext highlighter-rouge">ContentProvider.onCreate()</code> 里（具体是 <code class="language-plaintext highlighter-rouge">AppWatcherInstaller</code>），而 <code class="language-plaintext highlighter-rouge">ContentProvider.onCreate()</code> 会早于 <code class="language-plaintext highlighter-rouge">Application.onCreate</code> 被调用</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-code"><pre><span class="c1">// ContentProvider.onCreate 会早于 Application.onCreate</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nc">ActivityThread</span><span class="o">.</span><span class="na">handleBindApplication</span><span class="o">(</span><span class="nc">AppBindData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="c1">// If the app is being launched for full backup or restore, bring it up in</span>
    <span class="c1">// a restricted environment with the base application class.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">makeApplication</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">restrictedBackupMode</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// Propagate autofill compat state</span>
    <span class="n">app</span><span class="o">.</span><span class="na">setAutofillOptions</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">autofillOptions</span><span class="o">);</span>
    <span class="c1">// Propagate Content Capture options</span>
    <span class="n">app</span><span class="o">.</span><span class="na">setContentCaptureOptions</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">contentCaptureOptions</span><span class="o">);</span>
    <span class="n">mInitialApplication</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
    <span class="c1">// don't bring up providers in restricted mode; they may depend on the</span>
    <span class="c1">// app's custom Application class</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">data</span><span class="o">.</span><span class="na">restrictedBackupMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">ArrayUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">providers</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">installContentProviders</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">providers</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// Do this after providers, since instrumentation tests generally start their</span>
    <span class="c1">// test thread at this point, and we don't want that racing.</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">instrumentationArgs</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
            <span class="s">"Exception thrown in onCreate() of "</span>
            <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">callApplicationOnCreate</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
              <span class="s">"Unable to create application "</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
              <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">installContentProviders</span><span class="o">(</span>
        <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProviderInfo</span><span class="o">&gt;</span> <span class="n">providers</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ContentProviderHolder</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ProviderInfo</span> <span class="n">cpi</span> <span class="o">:</span> <span class="n">providers</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ContentProviderHolder</span> <span class="n">cph</span> <span class="o">=</span> <span class="n">installProvider</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">cpi</span><span class="o">,</span>
                <span class="kc">false</span> <span class="cm">/*noisy*/</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*noReleaseNeeded*/</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*stable*/</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cph</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cph</span><span class="o">.</span><span class="na">noReleaseNeeded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">results</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cph</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 实例化 ContentProvider 并调用生命周期函数 onCreate</span>
<span class="kd">private</span> <span class="nc">ContentProviderHolder</span> <span class="nc">ActivityThread</span><span class="o">.</span><span class="na">installProvider</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
        <span class="nc">ContentProviderHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="nc">ProviderInfo</span> <span class="n">info</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">noisy</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">noReleaseNeeded</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stable</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
    <span class="nc">LoadedApk</span> <span class="n">packageInfo</span> <span class="o">=</span> <span class="n">peekPackageInfo</span><span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">packageInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// System startup case.</span>
        <span class="n">packageInfo</span> <span class="o">=</span> <span class="n">getSystemContext</span><span class="o">().</span><span class="na">mPackageInfo</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">localProvider</span> <span class="o">=</span> <span class="n">packageInfo</span><span class="o">.</span><span class="na">getAppFactory</span><span class="o">()</span>
            <span class="o">.</span><span class="na">instantiateProvider</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">localProvider</span><span class="o">.</span><span class="na">getIContentProvider</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">provider</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Failed to instantiate class "</span> <span class="o">+</span>
              <span class="n">info</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" from sourceDir "</span> <span class="o">+</span>
              <span class="n">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_PROVIDER</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
        <span class="no">TAG</span><span class="o">,</span> <span class="s">"Instantiating local provider "</span> <span class="o">+</span> <span class="n">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="c1">// XXX Need to create the correct context for this provider.</span>
    <span class="n">localProvider</span><span class="o">.</span><span class="na">attachInfo</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">info</span><span class="o">);</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nc">ContentProvider</span><span class="o">.</span><span class="na">attachInfo</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ProviderInfo</span> <span class="n">info</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">attachInfo</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">info</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nc">ContentProvider</span><span class="o">.</span><span class="na">attachInfo</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ProviderInfo</span> <span class="n">info</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">testing</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>
    <span class="nc">ContentProvider</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="有什么缺点">有什么缺点</h3><ol><li><code class="language-plaintext highlighter-rouge">LeakCanary</code> 是在 app process 内 heap dump 的，期间进程内的其他线程会被挂起直到 heap dump 完成，这会导致 app 无响应，生产环境下是不可接受的<li>hprof 文件往往达到 400M / 500M 这个量级，客户端存储是个问题<li>hprof 文件要回传给服务器分析，但是文件太大网络消耗也有很大问题<li>如果是在客户端分析 hprof 文件，由于文件太大导致分析进程在很多情况下自己也 OOM 了</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96/'>内存优化</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/leakcanary/" class="post-tag no-text-decoration" >LeakCanary</a> <a href="/blog/tags/%E5%86%85%E5%AD%98/" class="post-tag no-text-decoration" >内存</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=浅析 LeakCanary - Cyrus&url=https://cyruslin.com/blog/blog/posts/leakcanary/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=浅析 LeakCanary - Cyrus&u=https://cyruslin.com/blog/blog/posts/leakcanary/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=浅析 LeakCanary - Cyrus&url=https://cyruslin.com/blog/blog/posts/leakcanary/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/posts/threadpool/">线程池 ThreadPool 的实现</a><li><a href="/blog/posts/juc-collection/">JUC 下一些线程安全的容器</a><li><a href="/blog/posts/reviews/">常见面试题备忘</a><li><a href="/blog/posts/https/">什么是 https ？</a><li><a href="/blog/posts/tcp-handshake-goodbye/">TCP 的三次握手和四次挥手</a></ul></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/posts/hashmap/"><div class="card-body"> <span class="timeago small" > Apr 5 <i class="unloaded">2021-04-05T12:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HashMap 的一些知识点</h3><div class="text-muted small"><p> HashMap 的桶由链表变为红黑树（树化）的过程 红黑树的特性 节点为红色或者黑色 根节点必须是黑的 红色节点的左右子节点必须为黑色 一个节点到叶子节点的每条路径必须包含相同数目的黑色节点 颜色变换和两种选择 添加新节点后，因为新节点总是红色的，那么会有几种情况出现： 新节点是根节点，也就是说树是空的，根据规则二，把新节点设为黑色即可 新节点的父节点...</p></div></div></a></div><div class="card"> <a href="/blog/posts/juc-collection/"><div class="card-body"> <span class="timeago small" > Mar 31 <i class="unloaded">2021-03-31T12:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JUC 下一些线程安全的容器</h3><div class="text-muted small"><p> 写时复制（Copy On Write） CopyOnWriteArrayList 使用 写时复制 实现的线程安全版 ArrayList，当发生修改操作时（add、set、remove）才加锁，将原数组复制一份并在上面修改成为新数组，最后用新数组替换原数组 public boolean add(E e) { synchronized (lock) { Object...</p></div></div></a></div><div class="card"> <a href="/blog/posts/https/"><div class="card-body"> <span class="timeago small" > Mar 30 <i class="unloaded">2021-03-30T12:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>什么是 https ？</h3><div class="text-muted small"><p> https = http + tls tcp 三次握手建立连接后，再进行 tls 握手/协商得到一个秘钥，然后双方使用这个秘钥加密（对称加密）明文的 http 为密文后再发送，同样双方收到密文后也用这个秘钥解密得到明文 对称加密 使用同一秘钥加密和解密，性能高，http 明文就是通过对称加密后才进行传输的，对称加密算法有：DES、3DES、AES 等；但秘钥交换是个问题，所以需要非对称加...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/posts/hashmap/" class="btn btn-outline-primary" prompt="Older"><p>HashMap 的一些知识点</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div></div></div>
