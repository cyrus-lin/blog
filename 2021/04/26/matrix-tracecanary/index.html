

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/image/favicon.png">
  <link rel="icon" href="/blog/image/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Cyrus">
  <meta name="keywords" content="">
  
  <title>Cyrus Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/docco.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/blog/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"cyruslin.com","root":"/blog/","version":"1.8.9-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":99},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"7d0c9146781b5fb9ae68cfc826d0be54","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>Cyrus Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/image/sunset_sea.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-04-26 00:00" pubdate>
        2021年4月26日
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      87
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body">
              <h2 id="无埋点插桩收集函数耗时"><a href="#无埋点插桩收集函数耗时" class="headerlink" title="无埋点插桩收集函数耗时"></a>无埋点插桩收集函数耗时</h2><p>为了在捕捉到卡顿堆栈后，获取各个函数的执行耗时，需要对所有函数进行无埋点插桩，在函数执行前调用 <code>MethodBeat.i</code>，在函数执行后调用 <code>MethodBeat.o</code></p>
<blockquote>
<p>实现细节</p>
<p>编译期：</p>
<p>通过代理编译期间的任务 <code>transformClassesWithDexTask</code>，将全局 <code>class</code> 文件作为输入，利用 <code>ASM</code> 工具，高效地对所有 <code>class</code> 文件进行扫描及插桩</p>
<p>插桩过程有几个关键点：</p>
<ol>
<li>选择在该编译任务执行时插桩，是因为 <code>proguard</code> 操作是在该任务之前就完成的，意味着插桩时的 <code>class</code> 文件已经被混淆过的。而选择 <code>proguard</code> 之后去插桩，是因为如果提前插桩会造成部分方法不符合内联规则，没法在 <code>proguard</code> 时进行优化，最终导致程序方法数无法减少，从而引发方法数过大问题</li>
<li>为了减少插桩量及性能损耗，通过遍历 <code>class</code> 方法指令集，判断扫描的函数是否只含有 <code>PUT/READ FIELD</code> 等简单的指令，来过滤一些默认或匿名构造函数，以及 <code>get/set</code> 等简单不耗时函数</li>
<li>针对界面启动耗时，因为要统计从 <code>Activity.onCreate</code> 到 <code>Activity.onWindowFocusChange</code> 间的耗时，所以在插桩过程中需要收集应用内所有 <code>Activity</code> 的实现类，并覆盖 <code>onWindowFocusChange</code> 函数进行打点</li>
<li>为了方便及高效记录函数执行过程，我们为每个插桩的函数分配一个独立 ID，在插桩过程中，记录插桩的函数签名及分配的 ID，在插桩完成后输出一份 mapping，作为数据上报后的解析支持。</li>
</ol>
<p>归纳起来，编译期所做的工作如下图：</p>
<p><img src="https://github.com/Tencent/matrix/wiki/images/trace/build.png" srcset="/blog/image/loading.gif" lazyload alt="transform class"></p>
</blockquote>
<h3 id="Gradle-Transform"><a href="#Gradle-Transform" class="headerlink" title="Gradle Transform"></a>Gradle Transform</h3><p><code>ignoreMethodMapFilePath</code> 上面说过为了减少插桩量及性能损耗会忽略一些函数，这些被忽略的函数记录在此文件里（默认放在 <code>/app/build/outputs/mapping/&#123;var&#125;/ignoreMethodMapping.txt</code>），大概长这样：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin">ignore methods:<br>android.arch.core.executor.ArchTaskExecutor &lt;clinit&gt; ()V<br>android.arch.core.executor.ArchTaskExecutor &lt;<span class="hljs-keyword">init</span>&gt; ()V<br>android.arch.core.executor.ArchTaskExecutor$<span class="hljs-number">1</span> execute (Ljava.lang.Runnable;)V<br>android.arch.core.executor.DefaultTaskExecutor executeOnDiskIO (Ljava.lang.Runnable;)V<br>android.arch.core.<span class="hljs-keyword">internal</span>.FastSafeIterableMap &lt;<span class="hljs-keyword">init</span>&gt; ()V<br>android.arch.core.<span class="hljs-keyword">internal</span>.FastSafeIterableMap ceil (Ljava.lang.Object;)Ljava.util.Map$Entry;<br>android.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap size ()I<br>android.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap equals (Ljava.lang.Object;)Z<br>android.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$AscendingIterator backward (Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;)Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;<br>android.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$AscendingIterator forward (Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;)Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;<br>android.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$AscendingIterator &lt;<span class="hljs-keyword">init</span>&gt; (Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;Landroid.arch.core.<span class="hljs-keyword">internal</span>.SafeIterableMap$Entry;)V<br></code></pre></div></td></tr></table></figure>

<p><code>methodMapFilePath</code> 函数签名和函数 ID 的映射（默认放在 <code>/app/build/outputs/mapping/&#123;var&#125;/methodMapping.txt</code>），大概长这样：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-number">1</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MainActivity$<span class="hljs-number">6</span> run ()V<br><span class="hljs-number">2</span>,<span class="hljs-number">10</span>,sample.tencent.matrix.MatrixApplication initSQLiteLintConfig ()Lcom.tencent.sqlitelint.config.SQLiteLintConfig;<br><span class="hljs-number">3</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MainActivity$<span class="hljs-number">5</span> onClick (Landroid.view.View;)V<br><span class="hljs-number">4</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MainActivity$<span class="hljs-number">4</span> onClick (Landroid.view.View;)V<br><span class="hljs-number">5</span>,<span class="hljs-number">4</span>,sample.tencent.matrix.MainActivity onResume ()V<br><span class="hljs-number">6</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MatrixApplication onCreate ()V<br><span class="hljs-number">7</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MainActivity$<span class="hljs-number">3</span> onClick (Landroid.view.View;)V<br><span class="hljs-number">8</span>,<span class="hljs-number">4</span>,sample.tencent.matrix.MainActivity onCreate (Landroid.os.Bundle;)V<br><span class="hljs-number">9</span>,<span class="hljs-number">1</span>,sample.tencent.matrix.MainActivity$<span class="hljs-number">2</span> onClick (Landroid.view.View;)V<br><span class="hljs-number">10</span>,<span class="hljs-number">1</span>,org.apache.commons.io.comparator.DirectoryFileComparator compare (Ljava.io.File;Ljava.io.File;)I<br></code></pre></div></td></tr></table></figure>

<p><code>TraceCanary</code> 用 <code>Transform API</code> 处理并输出插桩后的 <code>class</code> </p>
<figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MatrixTraceTransform</span>: <span class="hljs-type">Transform</span></span>() &#123;<br><br>    <span class="hljs-comment">// Transform 的名称</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>: String &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MatrixTraceTransform&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment">// Transform 接收 Input 处理并输出 Output</span><br>    <span class="hljs-comment">// 这里声明 MatrixTraceTransform 接收所有的 class，包括 class 文件和 jar 包中的 class</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInputTypes</span><span class="hljs-params">()</span></span>: Set&lt;QualifiedContent.ContentType&gt; &#123;<br>        <span class="hljs-keyword">return</span> TransformManager.CONTENT_CLASS<br>    &#125;<br><br>    <span class="hljs-comment">// 指定 class 的范围，限定项目内的所有 class</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScopes</span><span class="hljs-params">()</span></span>: MutableSet&lt;<span class="hljs-keyword">in</span> QualifiedContent.Scope&gt;? &#123;<br>        <span class="hljs-keyword">return</span> TransformManager.SCOPE_FULL_PROJECT<br>    &#125;<br><br>    <span class="hljs-comment">// 支持增量编译</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isIncremental</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transform</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.transform(transformInvocation)<br>        <span class="hljs-comment">// ...</span><br>        transforming(transformInvocation)<br>    &#125;<br><br>    <span class="hljs-comment">// 核心逻辑</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transforming</span><span class="hljs-params">(invocation: <span class="hljs-type">TransformInvocation</span>)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> start = System.currentTimeMillis()<br>        <span class="hljs-keyword">val</span> outputProvider = invocation.outputProvider!!<br>        <span class="hljs-keyword">val</span> isIncremental = invocation.isIncremental &amp;&amp; <span class="hljs-keyword">this</span>.isIncremental<br>        <span class="hljs-keyword">if</span> (!isIncremental) &#123;<br>            outputProvider.deleteAll()<br>        &#125;<br>        <span class="hljs-keyword">val</span> config = configure(invocation)<br><br>        <span class="hljs-keyword">val</span> changedFiles = ConcurrentHashMap&lt;File, Status&gt;()    <span class="hljs-comment">// 需要进行插桩的 class/jar</span><br>        <span class="hljs-keyword">val</span> inputToOutput = ConcurrentHashMap&lt;File, File&gt;()     <span class="hljs-comment">// Input Dir -&gt; Output Dir，Input Jar -&gt; Output Jar</span><br>        <span class="hljs-keyword">val</span> inputFiles = ArrayList&lt;File&gt;()                      <span class="hljs-comment">// Input Dir &amp;&amp; Input Jar</span><br>        <span class="hljs-keyword">var</span> transformDirectory: File? = <span class="hljs-literal">null</span><br>        <span class="hljs-keyword">for</span> (input <span class="hljs-keyword">in</span> invocation.inputs) &#123;<br><br>            <span class="hljs-comment">// 遍历并添加 class 文件</span><br>            <span class="hljs-keyword">for</span> (directoryInput <span class="hljs-keyword">in</span> input.directoryInputs) &#123;<br>                changedFiles.putAll(directoryInput.changedFiles)<br>                <span class="hljs-keyword">val</span> inputDir = directoryInput.file<br>                inputFiles.add(inputDir)<br>                <span class="hljs-keyword">val</span> outputDirectory = outputProvider.getContentLocation(<br>                        directoryInput.name,<br>                        directoryInput.contentTypes,<br>                        directoryInput.scopes,<br>                        Format.DIRECTORY)<br><br>                inputToOutput[inputDir] = outputDirectory<br>                <span class="hljs-keyword">if</span> (transformDirectory == <span class="hljs-literal">null</span>) transformDirectory = outputDirectory.parentFile<br>            &#125;<br><br>            <span class="hljs-comment">// 遍历并添加 jar 包</span><br>            <span class="hljs-keyword">for</span> (jarInput <span class="hljs-keyword">in</span> input.jarInputs) &#123;<br>                <span class="hljs-keyword">val</span> inputFile = jarInput.file<br>                changedFiles[inputFile] = jarInput.status<br>                inputFiles.add(inputFile)<br>                <span class="hljs-keyword">val</span> outputJar = outputProvider.getContentLocation(<br>                        jarInput.name,<br>                        jarInput.contentTypes,<br>                        jarInput.scopes,<br>                        Format.JAR)<br><br>                inputToOutput[inputFile] = outputJar<br>                <span class="hljs-keyword">if</span> (transformDirectory == <span class="hljs-literal">null</span>) transformDirectory = outputJar.parentFile<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (inputFiles.size == <span class="hljs-number">0</span> || transformDirectory == <span class="hljs-literal">null</span>) &#123;<br>            Log.i(TAG, <span class="hljs-string">&quot;Matrix trace do not find any input files&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br><br>        <span class="hljs-comment">// 执行插桩</span><br>        <span class="hljs-keyword">val</span> outputDirectory = transformDirectory<br>        MatrixTrace(<br>                ignoreMethodMapFilePath = config.ignoreMethodMapFilePath,<br>                methodMapFilePath = config.methodMapFilePath,<br>                baseMethodMapPath = config.baseMethodMapPath,   <span class="hljs-comment">// 上一次插桩的 method mapping file，记录了已分配的 method id，插桩时要复用</span><br>                blockListFilePath = config.blockListFilePath,   <span class="hljs-comment">// 黑名单机制，忽略匹配的函数</span><br>                mappingDir = config.mappingDir                  <span class="hljs-comment">// Proguard mapping file</span><br>        ).doTransform(<br>                classInputs = inputFiles,<br>                changedFiles = changedFiles,<br>                isIncremental = isIncremental,<br>                traceClassDirectoryOutput = outputDirectory,<br>                inputToOutput = inputToOutput,<br>                legacyReplaceChangedFile = <span class="hljs-literal">null</span>,<br>                legacyReplaceFile = <span class="hljs-literal">null</span>)<br><br>        <span class="hljs-keyword">val</span> cost = System.currentTimeMillis() - start<br>        Log.i(TAG, <span class="hljs-string">&quot; Insert matrix trace instrumentations cost time: %sms.&quot;</span>, cost)<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configure</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>)</span></span>: Configuration &#123;<br>        <span class="hljs-keyword">val</span> buildDir = project.buildDir.absolutePath<br>        <span class="hljs-keyword">val</span> dirName = transformInvocation.context.variantName<br>        <span class="hljs-keyword">val</span> mappingOut = Joiner.on(File.separatorChar).join(<br>                buildDir,<br>                FD_OUTPUTS,<br>                <span class="hljs-string">&quot;mapping&quot;</span>,<br>                dirName)<br><br>        <span class="hljs-keyword">return</span> Configuration.Builder()<br>                .setBaseMethodMap(extension.baseMethodMapFile)<br>                .setBlockListFile(extension.blackListFile)<br>                .setMethodMapFilePath(<span class="hljs-string">&quot;<span class="hljs-variable">$mappingOut</span>/methodMapping.txt&quot;</span>)<br>                .setIgnoreMethodMapFilePath(<span class="hljs-string">&quot;<span class="hljs-variable">$mappingOut</span>/ignoreMethodMapping.txt&quot;</span>)<br>                .setMappingPath(mappingOut)<br>                .build()<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="解析配置文件"><a href="#解析配置文件" class="headerlink" title="解析配置文件"></a>解析配置文件</h3><figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> MatrixTrace.<span class="hljs-title">doTransform</span><span class="hljs-params">(...)</span></span> &#123;<br>    <span class="hljs-keyword">val</span> executor: ExecutorService = Executors.newFixedThreadPool(<span class="hljs-number">16</span>)<br>    <span class="hljs-keyword">val</span> config = Configuration.Builder()<br>            .setIgnoreMethodMapFilePath(ignoreMethodMapFilePath)<br>            .setMethodMapFilePath(methodMapFilePath)<br>            .setBaseMethodMap(baseMethodMapPath)<br>            .setBlockListFile(blockListFilePath)<br>            .setMappingPath(mappingDir)<br>            .build()<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * step 1</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">var</span> start = System.currentTimeMillis()<br>    <span class="hljs-keyword">val</span> futures = LinkedList&lt;Future&lt;*&gt;&gt;()<br>    <span class="hljs-keyword">val</span> mappingCollector = MappingCollector()<br>    <span class="hljs-keyword">val</span> methodId = AtomicInteger(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">val</span> collectedMethodMap = ConcurrentHashMap&lt;String, TraceMethod&gt;()<br><br>    <span class="hljs-comment">// 在线程池里解析各种 mapping file</span><br>    futures.add(executor.submit(ParseMappingTask(<br>            mappingCollector, collectedMethodMap, methodId, config)))<br><br>    <span class="hljs-comment">// 在线程池里扫描 class dir 和 jar，将 Input 和 Output 映射好放在下面的两个 map 里</span><br>    <span class="hljs-keyword">val</span> dirInputOutMap = ConcurrentHashMap&lt;File, File&gt;()<br>    <span class="hljs-keyword">val</span> jarInputOutMap = ConcurrentHashMap&lt;File, File&gt;()<br>    <span class="hljs-keyword">for</span> (file <span class="hljs-keyword">in</span> classInputs) &#123;<br>        <span class="hljs-keyword">if</span> (file.isDirectory) &#123;<br>            futures.add(executor.submit(CollectDirectoryInputTask(<br>                    directoryInput = file,<br>                    mapOfChangedFiles = changedFiles,<br>                    mapOfInputToOutput = inputToOutput,<br>                    isIncremental = isIncremental,<br>                    traceClassDirectoryOutput = traceClassDirectoryOutput,<br>                    legacyReplaceChangedFile = legacyReplaceChangedFile,<br>                    legacyReplaceFile = legacyReplaceFile,<br>                    resultOfDirInputToOut = dirInputOutMap<br>            )))<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">val</span> status = Status.CHANGED<br>            futures.add(executor.submit(CollectJarInputTask(<br>                    inputJar = file,<br>                    inputJarStatus = status,<br>                    inputToOutput = inputToOutput,<br>                    isIncremental = isIncremental,<br>                    traceClassFileOutput = traceClassDirectoryOutput,<br>                    legacyReplaceFile = legacyReplaceFile,<br>                    resultOfDirInputToOut = dirInputOutMap,<br>                    resultOfJarInputToOut = jarInputOutMap<br>            )))<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (future <span class="hljs-keyword">in</span> futures) &#123;<br>        future.<span class="hljs-keyword">get</span>()<br>    &#125;<br>    futures.clear()<br>    Log.i(TAG, <span class="hljs-string">&quot;[doTransform] Step(1)[Parse]... cost:%sms&quot;</span>, System.currentTimeMillis() - start)<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParseMappingTask</span></span>(...) : Runnable &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">val</span> start = System.currentTimeMillis()<br>        <span class="hljs-keyword">val</span> mappingFile = File(config.mappingDir, <span class="hljs-string">&quot;mapping.txt&quot;</span>)    <span class="hljs-comment">// 解析 Proguard mapping file</span><br>        <span class="hljs-keyword">if</span> (mappingFile.isFile) &#123;<br>            <span class="hljs-keyword">val</span> mappingReader = MappingReader(mappingFile)<br>            mappingReader.read(mappingCollector)<br>        &#125;<br>        <span class="hljs-keyword">val</span> size = config.parseBlockFile(mappingCollector)          <span class="hljs-comment">// 解析黑名单</span><br>        <span class="hljs-keyword">val</span> baseMethodMapFile = File(config.baseMethodMapPath)      <span class="hljs-comment">// 加载已分配 method id 的函数列表</span><br>        getMethodFromBaseMethod(baseMethodMapFile, collectedMethodMap)<br>        retraceMethodMap(mappingCollector, collectedMethodMap)<br>        Log.i(TAG, <span class="hljs-string">&quot;[ParseMappingTask#run] cost:%sms, black size:%s, collect %s method from %s&quot;</span>,<br>                System.currentTimeMillis() - start, size, collectedMethodMap.size, config.baseMethodMapPath)<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="收集匹配的函数"><a href="#收集匹配的函数" class="headerlink" title="收集匹配的函数"></a>收集匹配的函数</h3><figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> MatrixTrace.<span class="hljs-title">doTransform</span><span class="hljs-params">(...)</span></span> &#123;<br>    <span class="hljs-comment">// ... step 2 在线程池里用 ASM 解析 class 并收集匹配的函数</span><br>    start = System.currentTimeMillis()<br>    <span class="hljs-keyword">val</span> methodCollector = MethodCollector(executor, mappingCollector, methodId, config, collectedMethodMap)<br>    methodCollector.collect(dirInputOutMap.keys, jarInputOutMap.keys)<br>    Log.i(TAG, <span class="hljs-string">&quot;[doTransform] Step(2)[Collection]... cost:%sms&quot;</span>, System.currentTimeMillis() - start)<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 搜集匹配的函数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> MethodCollector.collect(Set&lt;File&gt; srcFolderList, Set&lt;File&gt; dependencyJarList) <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    List&lt;Future&gt; futures = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (File srcFile : srcFolderList) &#123;                    <span class="hljs-comment">// 在 class 里收集匹配的函数</span><br>        ArrayList&lt;File&gt; classFileList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (srcFile.isDirectory()) &#123;<br>            listClassFiles(classFileList, srcFile);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            classFileList.add(srcFile);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (File classFile : classFileList) &#123;<br>            futures.add(executor.submit(<span class="hljs-keyword">new</span> CollectSrcTask(classFile)));<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (File jarFile : dependencyJarList) &#123;                <span class="hljs-comment">// 在 jar 包里收集匹配的函数</span><br>        futures.add(executor.submit(<span class="hljs-keyword">new</span> CollectJarTask(jarFile)));<br>    &#125;<br>    <span class="hljs-keyword">for</span> (Future future : futures) &#123;<br>        future.get();<br>    &#125;<br>    futures.clear();<br>    futures.add(executor.submit(<span class="hljs-keyword">new</span> Runnable() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            saveIgnoreCollectedMethod(mappingCollector);    <span class="hljs-comment">// 写入 ignored methods 到文件里</span><br>        &#125;<br>    &#125;));<br>    futures.add(executor.submit(<span class="hljs-keyword">new</span> Runnable() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            saveCollectedMethod(mappingCollector);          <span class="hljs-comment">// 将 method id -&gt; method 映射写入文件里</span><br>        &#125;<br>    &#125;));<br>    <span class="hljs-keyword">for</span> (Future future : futures) &#123;<br>        future.get();<br>    &#125;<br>    futures.clear();<br>&#125;<br><br><span class="hljs-comment">// 用 ASM Core API 解析并找到匹配的函数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> CollectMethodNode.visitEnd() &#123;<br>    <span class="hljs-keyword">super</span>.visitEnd();<br>    TraceMethod traceMethod = TraceMethod.create(<span class="hljs-number">0</span>, access, className, name, desc);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;&lt;init&gt;&quot;</span>.equals(name)) &#123;<br>        isConstructor = <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 过滤掉空函数、getter/setter 等，加入 ignored method file 里</span><br>    <span class="hljs-keyword">boolean</span> isNeedTrace = isNeedTrace(configuration, traceMethod.className, mappingCollector);<br>    <span class="hljs-keyword">if</span> ((isEmptyMethod() || isGetSetMethod() || isSingleMethod())<br>            &amp;&amp; isNeedTrace) &#123;<br>        ignoreCount.incrementAndGet();<br>        collectedIgnoreMethodMap.put(traceMethod.getMethodName(), traceMethod);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 需要插桩的函数，如果没有 method id 则分配一个自增的 method id，加入 collectedMethodMap</span><br>    <span class="hljs-keyword">if</span> (isNeedTrace &amp;&amp; !collectedMethodMap.containsKey(traceMethod.getMethodName())) &#123;<br>        traceMethod.id = methodId.incrementAndGet();<br>        collectedMethodMap.put(traceMethod.getMethodName(), traceMethod);<br>        incrementCount.incrementAndGet();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isNeedTrace &amp;&amp; !collectedIgnoreMethodMap.containsKey(traceMethod.className)) &#123;<br>        ignoreCount.incrementAndGet();<br>        collectedIgnoreMethodMap.put(traceMethod.getMethodName(), traceMethod);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Jar 包则用 ZipFile API 遍历，依然用 ASM 解析</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CollectJarTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        ZipFile zipFile = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            zipFile = <span class="hljs-keyword">new</span> ZipFile(fromJar);<br>            Enumeration&lt;? extends ZipEntry&gt; enumeration = zipFile.entries();<br>            <span class="hljs-keyword">while</span> (enumeration.hasMoreElements()) &#123;<br>                ZipEntry zipEntry = enumeration.nextElement();<br>                String zipEntryName = zipEntry.getName();<br>                <span class="hljs-keyword">if</span> (isNeedTraceFile(zipEntryName)) &#123;<br>                    InputStream inputStream = zipFile.getInputStream(zipEntry);<br>                    ClassReader classReader = <span class="hljs-keyword">new</span> ClassReader(inputStream);<br>                    ClassWriter classWriter = <span class="hljs-keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS);<br>                    ClassVisitor visitor = <span class="hljs-keyword">new</span> TraceClassAdapter(Opcodes.ASM5, classWriter);<br>                    classReader.accept(visitor, <span class="hljs-number">0</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="执行插桩操作"><a href="#执行插桩操作" class="headerlink" title="执行插桩操作"></a>执行插桩操作</h3><figure class="highlight kotlin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> MatrixTrace.<span class="hljs-title">doTransform</span><span class="hljs-params">(...)</span></span> &#123;<br>    <span class="hljs-comment">// ... step 3 执行插桩操作</span><br>    start = System.currentTimeMillis()<br>    <span class="hljs-keyword">val</span> methodTracer = MethodTracer(executor, mappingCollector, config, methodCollector.collectedMethodMap, methodCollector.collectedClassExtendMap)<br>    methodTracer.trace(dirInputOutMap, jarInputOutMap)<br>    Log.i(TAG, <span class="hljs-string">&quot;[doTransform] Step(3)[Trace]... cost:%sms&quot;</span>, System.currentTimeMillis() - start)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> MethodTracer.trace(Map&lt;File, File&gt; srcFolderList, Map&lt;File, File&gt; dependencyJarList) <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>    List&lt;Future&gt; futures = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>    traceMethodFromSrc(srcFolderList, futures);     <span class="hljs-comment">// 处理 class</span><br>    traceMethodFromJar(dependencyJarList, futures); <span class="hljs-comment">// 处理 jar</span><br>    <span class="hljs-keyword">for</span> (Future future : futures) &#123;<br>        future.get();<br>    &#125;<br>    futures.clear();<br>&#125;<br><br><span class="hljs-comment">// 一个线程处理一个 class/dir </span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">traceMethodFromSrc</span><span class="hljs-params">(Map&lt;File, File&gt; srcMap, List&lt;Future&gt; futures)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != srcMap) &#123;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;File, File&gt; entry : srcMap.entrySet()) &#123;<br>            futures.add(executor.submit(<span class="hljs-keyword">new</span> Runnable() &#123;<br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; innerTraceMethodFromSrc(entry.getKey(), entry.getValue()); &#125;<br>            &#125;));<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">innerTraceMethodFromSrc</span><span class="hljs-params">(File input, File output)</span> </span>&#123;<br>    <span class="hljs-comment">// ... 依然是 ASM 里 classReader，classWriter 和 classVisitor 的经典用法</span><br>    is = <span class="hljs-keyword">new</span> FileInputStream(classFile);<br>    ClassReader classReader = <span class="hljs-keyword">new</span> ClassReader(is);<br>    ClassWriter classWriter = <span class="hljs-keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS);<br>    ClassVisitor classVisitor = <span class="hljs-keyword">new</span> TraceClassAdapter(Opcodes.ASM5, classWriter);   <span class="hljs-comment">// 重要的类</span><br>    classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES);<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">public</span> MethodVisitor TraceClassAdapter.visitMethod(<span class="hljs-keyword">int</span> access, String name, String desc,<br>                                 String signature, String[] exceptions) &#123;<br>    <span class="hljs-keyword">if</span> (isABSClass) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!hasWindowFocusMethod) &#123;    <span class="hljs-comment">// 匹配 Activity.onWindowFocusChanged，做页面打开速度统计</span><br>            hasWindowFocusMethod = MethodCollector.isWindowFocusChangeMethod(name, desc);<br>        &#125;<br>        MethodVisitor methodVisitor = cv.visitMethod(access, name, desc, signature, exceptions);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TraceMethodAdapter(api, methodVisitor, access, name, desc, <span class="hljs-keyword">this</span>.className,<br>                hasWindowFocusMethod, isActivityOrSubClass, isNeedTrace);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 匹配 Activity.onWindowFocusChanged(boolean hasFocus)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD = <span class="hljs-string">&quot;onWindowFocusChanged&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS = <span class="hljs-string">&quot;(Z)V&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isWindowFocusChangeMethod</span><span class="hljs-params">(String name, String desc)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span> != name &amp;&amp; <span class="hljs-keyword">null</span> != desc &amp;&amp; name.equals(TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD) <br>        &amp;&amp; desc.equals(TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> TraceClassAdapter.visitEnd() &#123;<br>    <span class="hljs-keyword">if</span> (!hasWindowFocusMethod &amp;&amp; isActivityOrSubClass &amp;&amp; isNeedTrace) &#123;<br>        insertWindowFocusChangeMethod(cv, className);<br>    &#125;<br>    <span class="hljs-keyword">super</span>.visitEnd();<br>&#125;<br><br><span class="hljs-comment">// 如果 Activity 没有覆盖 onWindowFocusChanged 则覆盖之（需要在里面插桩统计页面打开速度）</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertWindowFocusChangeMethod</span><span class="hljs-params">(ClassVisitor cv, String classname)</span> </span>&#123;<br>    MethodVisitor methodVisitor = cv.visitMethod(Opcodes.ACC_PUBLIC, TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD,<br>            TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>    methodVisitor.visitCode();<br>    methodVisitor.visitVarInsn(Opcodes.ALOAD, <span class="hljs-number">0</span>);<br>    methodVisitor.visitVarInsn(Opcodes.ILOAD, <span class="hljs-number">1</span>);<br>    methodVisitor.visitMethodInsn(Opcodes.INVOKESPECIAL, TraceBuildConstants.MATRIX_TRACE_ACTIVITY_CLASS, <br>        TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD, TraceBuildConstants.MATRIX_TRACE_ON_WINDOW_FOCUS_METHOD_ARGS, <span class="hljs-keyword">false</span>);<br>    traceWindowFocusChangeMethod(methodVisitor, classname);<br>    methodVisitor.visitInsn(Opcodes.RETURN);<br>    methodVisitor.visitMaxs(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>    methodVisitor.visitEnd();<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TraceMethodAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AdviceAdapter</span> </span>&#123;<br>    <span class="hljs-comment">// 进入函数后先执行 MethodBeat.i</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span> </span>&#123;<br>        TraceMethod traceMethod = collectedMethodMap.get(methodName);<br>        <span class="hljs-keyword">if</span> (traceMethod != <span class="hljs-keyword">null</span>) &#123;<br>            traceMethodCount.incrementAndGet();<br>            mv.visitLdcInsn(traceMethod.id);<br>            mv.visitMethodInsn(INVOKESTATIC, TraceBuildConstants.MATRIX_TRACE_CLASS, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;(I)V&quot;</span>, <span class="hljs-keyword">false</span>);<br><br>            <span class="hljs-comment">// 在 onWindowFocusChanged 插入 AppMethodBeat.at</span><br>            <span class="hljs-keyword">if</span> (checkNeedTraceWindowFocusChangeMethod(traceMethod)) &#123;<br>                traceWindowFocusChangeMethod(mv, className);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 退出函数前，执行 MethodBeat.o</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMethodExit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> opcode)</span> </span>&#123;<br>        TraceMethod traceMethod = collectedMethodMap.get(methodName);<br>        <span class="hljs-keyword">if</span> (traceMethod != <span class="hljs-keyword">null</span>) &#123;<br>            traceMethodCount.incrementAndGet();<br>            mv.visitLdcInsn(traceMethod.id);<br>            mv.visitMethodInsn(INVOKESTATIC, TraceBuildConstants.MATRIX_TRACE_CLASS, <span class="hljs-string">&quot;o&quot;</span>, <span class="hljs-string">&quot;(I)V&quot;</span>, <span class="hljs-keyword">false</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// jar 包一样的，只不过用的 ZipFile API 那套 ...</span><br></code></pre></div></td></tr></table></figure>

<h3 id="收集函数执行耗时"><a href="#收集函数执行耗时" class="headerlink" title="收集函数执行耗时"></a>收集函数执行耗时</h3><p>用一个 <code>long</code> 记录 <code>i/o</code> 函数调用，高位第一位表示是 <code>i</code> 函数还是 <code>o</code> 函数，后续 20 位存储 <code>method id</code>，低位 43 位存储 <em>相对时间戳</em>；运行时分配一个 100W 长度的 long 数组（占内存 7.6M）来存储，从索引 0 开始逐步递增到数组尾部，满了又从索引 0 开始，会覆盖旧数据，但因为 100W 足够大，用来收集栈帧执行时间足够了</p>
<blockquote>
<p>编译期已经对全局的函数进行插桩，在运行期间每个函数的执行前后都会调用 MethodBeat.i/o 的方法，如果是在主线程中执行，则在函数的执行前后获取当前距离 MethodBeat 模块初始化的时间 offset（为了压缩数据，存进一个long类型变量中），并将当前执行的是 MethodBeat i或者o、mehtod id 及时间 offset，存放到一个 long 类型变量中，记录到一个预先初始化好的数组 long[] 中 index 的位置（预先分配记录数据的 buffer 长度为 100w，内存占用约 7.6M）。</p>
<p><img src="https://github.com/Tencent/matrix/wiki/images/trace/run_store.jpg" srcset="/blog/image/loading.gif" lazyload alt="long buffer"></p>
<p><img src="https://github.com/Tencent/matrix/wiki/images/trace/stack.jpg" srcset="/blog/image/loading.gif" lazyload alt="summary func cast"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 记录函数的开始时间</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> AppMethodBeat.i(<span class="hljs-keyword">int</span> methodId) &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">if</span> (threadId == sMainThreadId) &#123;                <span class="hljs-comment">// 只关心主线程的慢函数，其他线程不记录</span><br>        <span class="hljs-keyword">if</span> (assertIn) &#123;                             <span class="hljs-comment">// 防止重入</span><br>            android.util.Log.e(TAG, <span class="hljs-string">&quot;ERROR!!! AppMethodBeat.i Recursive calls!!!&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        assertIn = <span class="hljs-keyword">true</span>;<br>        <span class="hljs-keyword">if</span> (sIndex &lt; Constants.BUFFER_SIZE) &#123;       <span class="hljs-comment">// buffer 满了则重头开始，会覆盖掉旧数据</span><br>            mergeData(methodId, sIndex, <span class="hljs-keyword">true</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sIndex = <span class="hljs-number">0</span>;<br>            mergeData(methodId, sIndex, <span class="hljs-keyword">true</span>);<br>        &#125;<br>        ++sIndex;<br>        assertIn = <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 插入 buffer</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> AppMethodBeat.mergeData(<span class="hljs-keyword">int</span> methodId, <span class="hljs-keyword">int</span> index, <span class="hljs-keyword">boolean</span> isIn) &#123;<br>    <span class="hljs-keyword">if</span> (methodId == AppMethodBeat.METHOD_ID_DISPATCH) &#123;<br>        sCurrentDiffTime = SystemClock.uptimeMillis() - sDiffTime;<br>    &#125;<br>    <span class="hljs-keyword">long</span> trueId = <span class="hljs-number">0L</span>;                               <span class="hljs-comment">// 构造函数执行时间戳，第一位表示 i/o 操作</span><br>    <span class="hljs-keyword">if</span> (isIn) &#123;<br>        trueId |= <span class="hljs-number">1L</span> &lt;&lt; <span class="hljs-number">63</span>;<br>    &#125;<br>    trueId |= (<span class="hljs-keyword">long</span>) methodId &lt;&lt; <span class="hljs-number">43</span>;                <span class="hljs-comment">// 后续 20 位存储 method id</span><br>    trueId |= sCurrentDiffTime &amp; <span class="hljs-number">0x7FFFFFFFFFFL</span>;    <span class="hljs-comment">// 低 43 位存储相对时间戳</span><br>    sBuffer[index] = trueId;<br>    checkPileup(index);<br>    sLastIndex = index;<br>&#125;<br><span class="hljs-comment">// 记录函数的结束时间，跟上面是一样的</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> AppMethodBeat.o(<span class="hljs-keyword">int</span> methodId) &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">if</span> (Thread.currentThread().getId() == sMainThreadId) &#123;<br>        <span class="hljs-keyword">if</span> (sIndex &lt; Constants.BUFFER_SIZE) &#123;<br>            mergeData(methodId, sIndex, <span class="hljs-keyword">false</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sIndex = <span class="hljs-number">0</span>;<br>            mergeData(methodId, sIndex, <span class="hljs-keyword">false</span>);<br>        &#125;<br>        ++sIndex;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>值得注意的是，因为只有低 43 位存储时间戳，如果存储完整的时间戳那是不足的，而且在分析函数执行耗时用的是 duration = end - start，实际上不需要完整的时间戳，所以这里记录的是相对时间戳（<code>sCurrentDiffTime</code>）；而且为了性能，不在 <code>i/o</code> 函数里执行 <code>SystemClock.uptimeMillis()</code></p>
<p><code>sDiffTime</code> 记录加载类 <code>AppMethodBeat</code> 的时间戳，然后会起一个线程每隔 5ms 更新一次 <code>sCurrentDiffTime = SystemClock.uptimeMillis() - sDiffTime</code></p>
<blockquote>
<p>另外，考虑到每个方法执行前后都获取系统时间（System.nanoTime）会对性能影响比较大，而实际上，单个函数执行耗时小于 5ms 的情况，对卡顿来说不是主要原因，可以忽略不计，如果是多次调用的情况，则在它的父级方法中可以反映出来，所以为了减少对性能的影响，通过另一条更新时间的线程每 5ms 去更新一个时间变量，而每个方法执行前后只读取该变量来减少性能损耗。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Runnable sUpdateDiffTimeRunnable = <span class="hljs-keyword">new</span> Runnable() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>                <span class="hljs-keyword">while</span> (!isPauseUpdateTime &amp;&amp; status &gt; STATUS_STOPPED) &#123;<br>                    sCurrentDiffTime = SystemClock.uptimeMillis() - sDiffTime;<br>                    SystemClock.sleep(Constants.TIME_UPDATE_CYCLE_MS);<br>                &#125;<br>                <span class="hljs-keyword">synchronized</span> (updateTimeLock) &#123;<br>                    updateTimeLock.wait();<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            MatrixLog.e(TAG, <span class="hljs-string">&quot;&quot;</span> + e.toString());<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></div></td></tr></table></figure>

<h2 id="统计-APP-amp-页面启动耗时"><a href="#统计-APP-amp-页面启动耗时" class="headerlink" title="统计 APP &amp; 页面启动耗时"></a>统计 APP &amp; 页面启动耗时</h2><p>包括 <code>Application</code> 执行耗时、首屏启动耗时、冷/热启动耗时、页面启动耗时，它们之间的关系如下：</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * firstMethod.i       LAUNCH_ACTIVITY   onWindowFocusChange   LAUNCH_ACTIVITY    onWindowFocusChange</span><br><span class="hljs-comment"> * ^                         ^                   ^                     ^                  ^</span><br><span class="hljs-comment"> * |                         |                   |                     |                  |</span><br><span class="hljs-comment"> * |---------app---------|---|---firstActivity---|---------...---------|---careActivity---|</span><br><span class="hljs-comment"> * |&lt;--applicationCost--&gt;|</span><br><span class="hljs-comment"> * |&lt;--------------firstScreenCost--------------&gt;|</span><br><span class="hljs-comment"> * |&lt;---------------------------------------coldCost-------------------------------------&gt;|</span><br><span class="hljs-comment"> * .                         |&lt;-----warmCost----&gt;|</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br></code></pre></div></td></tr></table></figure>

<h3 id="Application-执行耗时"><a href="#Application-执行耗时" class="headerlink" title="Application 执行耗时"></a><code>Application</code> 执行耗时</h3><p>通过给 <code>Application.attachBaseContext</code> 插桩，也就是第一次执行 <code>AppMethodBeat.i</code> 的时候，可以拿到 <code>eggBrokenTime</code> 作为 APP 启动时间</p>
<p>这里解释下为什么不在 <code>Application</code> 构造函数里插桩并作为 APP 启动时间，那是因为 APP 有冷启动/热启动的概念，冷启动下 fork app process 并构造 <code>Application</code> 实例，此时算出的启动时间是正确的；但如果是热启动，<code>Application</code> 实例并没有销毁也不会执行构造函数，而是直接走 <code>onCreate</code> 函数，此时在构造函数里插桩就无法捕获到正确的启动时间了</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppMethodBeat</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">i</span><span class="hljs-params">(<span class="hljs-keyword">int</span> methodId)</span> </span>&#123;<br>        <span class="hljs-comment">// ... 第一次执行 AppMethodBeat.i 时</span><br>        <span class="hljs-keyword">if</span> (status == STATUS_DEFAULT) &#123;<br>            <span class="hljs-keyword">synchronized</span> (statusLock) &#123;<br>                <span class="hljs-keyword">if</span> (status == STATUS_DEFAULT) &#123;<br>                    realExecute();<br>                    status = STATUS_READY;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">realExecute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        ActivityThreadHacker.hackSysHandlerCallback();<br>        <span class="hljs-comment">/// ...</span><br>    &#125;        <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActivityThreadHacker</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> sApplicationCreateBeginTime = <span class="hljs-number">0L</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getEggBrokenTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> ActivityThreadHacker.sApplicationCreateBeginTime;<br>    &#125;    <br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hackSysHandlerCallback</span><span class="hljs-params">()</span> </span>&#123;<br>        sApplicationCreateBeginTime = SystemClock.uptimeMillis();   <span class="hljs-comment">// 记录 Application 的创建时间</span><br>        <span class="hljs-comment">// ...</span><br>    &#125;    <br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>初始化 <code>Application</code> 后启动第一个 <code>Activity</code>/<code>Service</code>/<code>BroadcastReceiver</code> 的时刻作为 <code>Application</code> 初始化的完结时间（为啥没有 <code>ContentProvider</code> 呢？因为它是在 <code>onCreate</code> 之前启动的，see <a href="../../../../2021/04/12/leakcanary/">LeakCanary 浅析</a>）</p>
<p>上述三大组件的启动会通过主线程的消息队列在 <code>ActivityThread.mH</code> 里执行</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CREATE_SERVICE          = <span class="hljs-number">114</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> RECEIVER                = <span class="hljs-number">113</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> RELAUNCH_ACTIVITY       = <span class="hljs-number">160</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> EXECUTE_TRANSACTION     = <span class="hljs-number">159</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span><span class="hljs-params">(Message msg)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="hljs-string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));<br>        <span class="hljs-keyword">switch</span> (msg.what) &#123;<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">case</span> CREATE_SERVICE:<br>                <span class="hljs-keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) &#123;<br>                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,<br>                            (<span class="hljs-string">&quot;serviceCreate: &quot;</span> + String.valueOf(msg.obj)));<br>                &#125;<br>                handleCreateService((CreateServiceData)msg.obj);<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">break</span>;<br>            <br>            <span class="hljs-keyword">case</span> RECEIVER:<br>                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;broadcastReceiveComp&quot;</span>);<br>                handleReceiver((ReceiverData)msg.obj);<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> RELAUNCH_ACTIVITY:<br>                handleRelaunchActivityLocally((IBinder) msg.obj);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> EXECUTE_TRANSACTION:<br>                <span class="hljs-keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;<br>                mTransactionExecutor.execute(transaction);<br>                <span class="hljs-keyword">if</span> (isSystem()) &#123;<br>                    <span class="hljs-comment">// Client transactions inside system process are recycled on the client side</span><br>                    <span class="hljs-comment">// instead of ClientLifecycleManager to avoid being cleared before this</span><br>                    <span class="hljs-comment">// message is handled.</span><br>                    transaction.recycle();<br>                &#125;<br>                <span class="hljs-comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span><br>                <span class="hljs-keyword">break</span>;<br><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// Activity 生命周期是通过 LaunchActivityItem/StartActivityItem/ResumeActivityItem/... 执行</span><br></code></pre></div></td></tr></table></figure>

<p>所以 <code>TraceCanary</code> 选择在第一次执行 <code>AppMethodBeat.i</code> 时，替换 <code>ActivityThread.sCurrentActivityThread.mH.mCallback</code>，在 <code>Handler.Callback.handleMessage(msg)</code> 里监听第一次启动 <code>Activity</code>/<code>Service</code>/<code>BroadcastReceiver</code> 的时刻作为 <code>Application</code> 初始化的结束点</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">// 第一次执行时</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> AppMethodBeat.i(<span class="hljs-keyword">int</span> methodId) &#123;<br>    <span class="hljs-keyword">if</span> (status &lt;= STATUS_STOPPED) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (methodId &gt;= METHOD_ID_MAX) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (status == STATUS_DEFAULT) &#123;<br>        <span class="hljs-keyword">synchronized</span> (statusLock) &#123;<br>            <span class="hljs-keyword">if</span> (status == STATUS_DEFAULT) &#123;<br>                realExecute();<br>                status = STATUS_READY;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// 替换 Handler.Callback</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> AppMethodBeat.realExecute() &#123;<br>    <span class="hljs-comment">// ...</span><br>    ActivityThreadHacker.hackSysHandlerCallback();<br>    LooperMonitor.register(looperMonitorListener);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> ActivityThreadHacker.hackSysHandlerCallback() &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        sApplicationCreateBeginTime = SystemClock.uptimeMillis();<br>        sApplicationCreateBeginMethodIndex = AppMethodBeat.getInstance().maskIndex(<span class="hljs-string">&quot;ApplicationCreateBeginMethodIndex&quot;</span>);<br>        Class&lt;?&gt; forName = Class.forName(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>        Field field = forName.getDeclaredField(<span class="hljs-string">&quot;sCurrentActivityThread&quot;</span>);<br>        field.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object activityThreadValue = field.get(forName);<br>        Field mH = forName.getDeclaredField(<span class="hljs-string">&quot;mH&quot;</span>);<br>        mH.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object handler = mH.get(activityThreadValue);<br>        Class&lt;?&gt; handlerClass = handler.getClass().getSuperclass();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != handlerClass) &#123;<br>            Field callbackField = handlerClass.getDeclaredField(<span class="hljs-string">&quot;mCallback&quot;</span>);<br>            callbackField.setAccessible(<span class="hljs-keyword">true</span>);<br>            Handler.Callback originalCallback = (Handler.Callback) callbackField.get(handler);<br>            HackCallback callback = <span class="hljs-keyword">new</span> HackCallback(originalCallback);<br>            callbackField.set(handler, callback);<br>        &#125;<br>        MatrixLog.i(TAG, <span class="hljs-string">&quot;hook system handler completed. start:%s SDK_INT:%s&quot;</span>, sApplicationCreateBeginTime, Build.VERSION.SDK_INT);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        MatrixLog.e(TAG, <span class="hljs-string">&quot;hook system handler err! %s&quot;</span>, e.getCause().toString());<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 记录时间点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> HackCallback.handleMessage(Message msg) &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">boolean</span> isLaunchActivity = isLaunchActivity(msg);<br>    <span class="hljs-keyword">if</span> (hasPrint &gt; <span class="hljs-number">0</span>) &#123;<br>        MatrixLog.i(TAG, <span class="hljs-string">&quot;[handleMessage] msg.what:%s begin:%s isLaunchActivity:%s SDK_INT=%s&quot;</span>, msg.what, SystemClock.uptimeMillis()isLaunchActivity, Build.VERSION.SDK_INT);<br>        hasPrint--;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!isCreated) &#123;<br>        <span class="hljs-keyword">if</span> (isLaunchActivity || msg.what == CREATE_SERVICE<br>                || msg.what == RECEIVER) &#123; <span class="hljs-comment">// todo for provider</span><br>            ActivityThreadHacker.sApplicationCreateEndTime = SystemClock.uptimeMillis();<br>            ActivityThreadHacker.sApplicationCreateScene = msg.what;<br>            isCreated = <span class="hljs-keyword">true</span>;<br>            sIsCreatedByLaunchActivity = isLaunchActivity;<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;application create end, sApplicationCreateScene:%d, isLaunchActivity:%s&quot;</span>, msg.what, isLaunchActivity);<br>            <span class="hljs-keyword">synchronized</span> (listeners) &#123;<br>                <span class="hljs-keyword">for</span> (IApplicationCreateListener listener : listeners) &#123;<br>                    listener.onApplicationCreateEnd();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span> != mOriginalCallback &amp;&amp; mOriginalCallback.handleMessage(msg);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="页面打开耗时"><a href="#页面打开耗时" class="headerlink" title="页面打开耗时"></a>页面打开耗时</h3><p>注册 <code>ActivityLifecycleCallbacks</code>，在 <code>onActivityCreated</code> 记录 <code>Activity</code> 的创建时间</p>
<p>在上面的插桩阶段，<code>AppMethodBeat.at(activity, isFocus)</code> 被添加到 <code>Activity.onWindowFocusChanged(hasFocus)</code> 的第一行代码，此时认为 <code>Activity</code> 获得焦点启动完毕（用户可见可交互），与 <code>Activity</code> 创建时间的差即为页面启动耗时</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartupTracer</span> </span>&#123;<br><br>    <span class="hljs-comment">// &quot;&#123;Activity全限定类名&#125;@&#123;activity.hashCode()&#125;&quot; -&gt; uptimeMillis</span><br>    <span class="hljs-keyword">private</span> HashMap&lt;String, Long&gt; createdTimeMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAlive</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.onAlive();<br>        MatrixLog.i(TAG, <span class="hljs-string">&quot;[onAlive] isStartupEnable:%s&quot;</span>, isStartupEnable);<br>        <span class="hljs-keyword">if</span> (isStartupEnable) &#123;<br>            AppMethodBeat.getInstance().addListener(<span class="hljs-keyword">this</span>);                              <span class="hljs-comment">// 添加 onWindowFocusChanged(hasFocus) 监视器</span><br>            Matrix.with().getApplication().registerActivityLifecycleCallbacks(<span class="hljs-keyword">this</span>);    <span class="hljs-comment">// 注册 ActivityLifecycleCallbacks</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityCreated</span><span class="hljs-params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;<br>        MatrixLog.i(TAG, <span class="hljs-string">&quot;activeActivityCount:%d, coldCost:%d&quot;</span>, activeActivityCount, coldCost);<br>        <span class="hljs-keyword">if</span> (activeActivityCount == <span class="hljs-number">0</span> &amp;&amp; coldCost &gt; <span class="hljs-number">0</span>) &#123;<br>            lastCreateActivity = uptimeMillis();<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;lastCreateActivity:%d, activity:%s&quot;</span>, lastCreateActivity, activity.getClass().getName());<br>            isWarmStartUp = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        activeActivityCount++;<br>        <span class="hljs-keyword">if</span> (isShouldRecordCreateTime) &#123;<br>            createdTimeMap.put(activity.getClass().getName() + <span class="hljs-string">&quot;@&quot;</span> + activity.hashCode(), uptimeMillis());  <span class="hljs-comment">// 记录 Activity 创建时间</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 当 Activity.onWindowFocusChanged(hasFocus) hasFocus == true 时被调用</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityFocused</span><span class="hljs-params">(Activity activity)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (ActivityThreadHacker.sApplicationCreateScene == Integer.MIN_VALUE) &#123;<br>            Log.w(TAG, <span class="hljs-string">&quot;start up from unknown scene&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        String activityName = activity.getClass().getName();<br>        <span class="hljs-keyword">if</span> (isColdStartup()) &#123;<br>            <span class="hljs-keyword">boolean</span> isCreatedByLaunchActivity = ActivityThreadHacker.isCreatedByLaunchActivity();<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;#ColdStartup# activity:%s, splashActivities:%s, empty:%b, &quot;</span><br>                            + <span class="hljs-string">&quot;isCreatedByLaunchActivity:%b, hasShowSplashActivity:%b, &quot;</span><br>                            + <span class="hljs-string">&quot;firstScreenCost:%d, now:%d, application_create_begin_time:%d, app_cost:%d&quot;</span>,<br>                    activityName, splashActivities, splashActivities.isEmpty(), isCreatedByLaunchActivity,<br>                    hasShowSplashActivity, firstScreenCost, uptimeMillis(),<br>                    ActivityThreadHacker.getEggBrokenTime(), ActivityThreadHacker.getApplicationCost());<br><br>            String key = activityName + <span class="hljs-string">&quot;@&quot;</span> + activity.hashCode();<br>            Long createdTime = createdTimeMap.get(key);<br>            <span class="hljs-keyword">if</span> (createdTime == <span class="hljs-keyword">null</span>) &#123;<br>                createdTime = <span class="hljs-number">0L</span>;<br>            &#125;<br>            createdTimeMap.put(key, uptimeMillis() - createdTime);      <span class="hljs-comment">// 页面启动耗时</span><br>            <span class="hljs-comment">// ...</span><br>    &#125;    <br>&#125;<br><br><span class="hljs-comment">// 当进入 Activity.onWindowFocusChanged(hasFocus) 函数时首先会执行此函数</span><br>AppMethodBeat.at(Activity activity, <span class="hljs-keyword">boolean</span> isFocus) &#123;<br>    String activityName = activity.getClass().getName();<br>    <span class="hljs-keyword">if</span> (isFocus) &#123;<br>        <span class="hljs-keyword">if</span> (sFocusActivitySet.add(activityName)) &#123;<br>            <span class="hljs-keyword">synchronized</span> (listeners) &#123;<br>                <span class="hljs-keyword">for</span> (IAppMethodBeatListener listener : listeners) &#123;<br>                    listener.onActivityFocused(activity);<br>                &#125;<br>            &#125;<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;[at] visibleScene[%s] has %s focus!&quot;</span>, getVisibleScene(), <span class="hljs-string">&quot;attach&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (sFocusActivitySet.remove(activityName)) &#123;<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;[at] visibleScene[%s] has %s focus!&quot;</span>, getVisibleScene(), <span class="hljs-string">&quot;detach&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="首屏打开耗时"><a href="#首屏打开耗时" class="headerlink" title="首屏打开耗时"></a>首屏打开耗时</h3><p>首屏启动耗时（<code>firstScreenCost</code>） = 第一个页面（splash activity）接收到焦点的时间 - <code>eggBrokenTime</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartupTracer</span> </span>&#123;    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityFocused</span><span class="hljs-params">(Activity activity)</span> </span>&#123;<br>        <span class="hljs-comment">// ... 记录首屏启动耗时</span><br>        <span class="hljs-keyword">if</span> (firstScreenCost == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">this</span>.firstScreenCost = uptimeMillis() - ActivityThreadHacker.getEggBrokenTime();<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="冷启动和热启动耗时"><a href="#冷启动和热启动耗时" class="headerlink" title="冷启动和热启动耗时"></a>冷启动和热启动耗时</h3><p>当打开一个 <code>Activity</code> 时，如果 app process 不存在则需要通过 <code>zygote</code> 进程 <code>fork</code> 出 app process，实例化并执行 <code>Application.onCreate</code> 后再启动 <code>Activity</code>，这叫做 <strong>冷启动</strong>；APP 退出后，系统在内存充足的情况下并不会立刻销毁 app process，重新打开 APP 虽然会走 <code>Application.onCreate</code> 再打开 <code>Activity</code>，但这个 <code>Application</code> 实例并没有销毁（实际上是 JVM 没有被销毁），这叫 <strong>热启动</strong></p>
<p>怎么判断是冷启动还是热启动呢？既然 JVM 没有销毁，那么类的静态成员变量作为 <code>GC ROOT</code> 就会一直存在于内存中，判断它有没初始化即可知道是冷启动还是热启动，实际上 <code>Matrix</code> 就是这么做的，它的 <code>GC ROOT PATH</code> 是：</p>
<p><code>Matrix.sInstance</code> -&gt; <code>HashSet&lt;Plugin&gt; plugins</code> -&gt; <code>TracePlugin</code> -&gt; <code>StartupTracer</code> -&gt; <code>coldCost</code></p>
<p><code>StartupTracer.coldCost</code> 会在 <code>StartupTracer.onActivityFocused</code> 被初始化（&gt; 0），初始化时如果遇到 <code>StartupTracer.coldCost</code> == 0 则是冷启动；跟我想的不太一样的是，我认为冷启动耗时是从 <code>eggBrokenTime</code> 到第一个页面（splash activity）打开的时间，而 <code>TraceCanary</code> 计算的是到第二个页面（splash activity 之后的第一个页面）打开的时间</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> StartupTracer.onActivityFocused(Activity activity) &#123;<br>    <span class="hljs-comment">// ... coldCost == 0 冷启动</span><br>    <span class="hljs-keyword">if</span> (isColdStartup()) &#123;                                             <br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">if</span> (hasShowSplashActivity) &#123;<br>            coldCost = uptimeMillis() - ActivityThreadHacker.getEggBrokenTime();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (splashActivities.contains(activityName)) &#123;<br>                hasShowSplashActivity = <span class="hljs-keyword">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (splashActivities.isEmpty()) &#123;            <span class="hljs-comment">// process which is has activity but not main UI process</span><br>                <span class="hljs-keyword">if</span> (isCreatedByLaunchActivity) &#123;<br>                    coldCost = firstScreenCost;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    firstScreenCost = <span class="hljs-number">0</span>;<br>                    coldCost = ActivityThreadHacker.getApplicationCost();<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (isCreatedByLaunchActivity) &#123;<br>                    coldCost = firstScreenCost;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    firstScreenCost = <span class="hljs-number">0</span>;<br>                    coldCost = ActivityThreadHacker.getApplicationCost();<br>                &#125;<br>            &#125;<br>        &#125;   <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>上面说过冷启动耗时是到第二个页面打开的时间，那如果在第一个页面打开时 <code>coldCost</code> &gt; 0 说明 JVM 没有销毁，是热启动（<code>isWarmStartUp</code>），热启动耗时相当于第一个页面的打开耗时</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartupTracer</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> lastCreateActivity = <span class="hljs-number">0L</span>;   <span class="hljs-comment">// 当前/上一个 Activity.onCreate 的时间</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> StartupTracer.onActivityCreated(Activity activity, Bundle savedInstanceState) &#123;<br>        MatrixLog.i(TAG, <span class="hljs-string">&quot;activeActivityCount:%d, coldCost:%d&quot;</span>, activeActivityCount, coldCost);<br>        <span class="hljs-keyword">if</span> (activeActivityCount == <span class="hljs-number">0</span> &amp;&amp; coldCost &gt; <span class="hljs-number">0</span>) &#123;<br>            lastCreateActivity = uptimeMillis();<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;lastCreateActivity:%d, activity:%s&quot;</span>, lastCreateActivity, activity.getClass().getName());<br>            isWarmStartUp = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        activeActivityCount++;<br>        <span class="hljs-keyword">if</span> (isShouldRecordCreateTime) &#123;<br>            createdTimeMap.put(activity.getClass().getName() + <span class="hljs-string">&quot;@&quot;</span> + activity.hashCode(), uptimeMillis());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> StartupTracer.onActivityFocused(Activity activity) &#123;<br>        <span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isWarmStartUp()) &#123;<br>            isWarmStartUp = <span class="hljs-keyword">false</span>;<br>            <span class="hljs-keyword">long</span> warmCost = uptimeMillis() - lastCreateActivity;<br>            MatrixLog.i(TAG, <span class="hljs-string">&quot;#WarmStartup# activity:%s, warmCost:%d, now:%d, lastCreateActivity:%d&quot;</span>, activityName, warmCost, uptimeMillis(), lastCreateActivity);<br><br>            <span class="hljs-keyword">if</span> (warmCost &gt; <span class="hljs-number">0</span>) &#123;<br>                analyse(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, warmCost, <span class="hljs-keyword">true</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.wanandroid.com/blog/show/2937">ASM 入门</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dengshiwei/asm-module/blob/master/doc/blog/AOP%20%E5%88%A9%E5%99%A8%20ASM%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8.md">AOP 利器 ASM 基础入门</a></li>
<li><a target="_blank" rel="noopener" href="https://su18.org/post/Nlwq9S-Ru/">字节码及ASM入门</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/031b62d02607">Gradle Transform API 的基本使用</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Tencent/matrix/wiki/Matrix-Android-TraceCanary">Matrix Android TraceCanary</a></li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/04/23/matrix-resourcescanary/">
                        <span class="hidden-mobile">Matrix - ResourcesCanary 浅析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7d0c9146781b5fb9ae68cfc826d0be54";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>


</body>
</html>
